QUERY UTILI:

- SELECT 
	GJE.CreatedDateTime,
	GJE.AccountingDate,
    GJE.Ledger,
    GJE.PostingLayer,
    GJE.SubledgerVoucher,
    GJE.SubledgerVoucherDataAreaId,
    GJE.CreatedBy,
    JC.Label AS JournalCategory,
    GJAE.AccountingCurrencyAmount,
    PT.Label AS PostingType,
	GJAE.PostingType,
    GJAE.MainAccount,
    GJAE.Text,
    GJAE.ReportingCurrencyAmount,
    GJAE.TransactionCurrencyAmount,
    GJAE.TransactionCurrencyCode
    --SDH.TypeEnumName
	------------
/*	GJE.RECID,
	GJAE.GeneralJournalEntry,
	GJE.JOURNALCATEGORY,
	JC.Value,
	GJAE.RECID,
	SJAE.GENERALJOURNALACCOUNTENTRY,
	SJAE.SUBLEDGERJOURNALENTRY,
	SJE.RECID,
	SJE.ACCOUNTINGEVENT,
	AE.RECID,
	AE.SOURCEDOCUMENTHEADER,
	SDH.RECID
*/
FROM GENERALJOURNALENTRY GJE
JOIN GENERALJOURNALACCOUNTENTRY GJAE ON GJE.RECID = GJAE.GeneralJournalEntry
JOIN POSTINGTYPE PT ON PT.Value = GJAE.POSTINGTYPE
JOIN JOURNALCATEGORY JC ON GJE.JOURNALCATEGORY = JC.Value

WHERE GJE.SUBLEDGERVOUCHERDATAAREAID = 'it01'

ORDER BY GJE.CREATEDDATETIME

-- Ordino per createddatetime o accounting date?



--CREATE VIEW CLOSINGTRANSACTION AS
SELECT 
    GJE.AccountingDate,
    GJE.Ledger,
    GJE.PostingLayer,
    GJE.SubledgerVoucher,
    GJE.SubledgerVoucherDataAreaId,
    GJE.CreatedDateTime,
    GJE.CreatedBy,
    JC.Label AS JournalCategory,
    GJAE.AccountingCurrencyAmount,
    PT.Label AS PostingType,
	GJAE.PostingType,
    GJAE.MainAccount,
    GJAE.Text,
    GJAE.ReportingCurrencyAmount,
    GJAE.TransactionCurrencyAmount,
    GJAE.TransactionCurrencyCode
    --SDH.TypeEnumName
	--
/*	GJE.RECID,
	GJAE.GeneralJournalEntry,
	GJE.JOURNALCATEGORY,
	JC.Value,
	GJAE.RECID,
	SJAE.GENERALJOURNALACCOUNTENTRY,
	SJAE.SUBLEDGERJOURNALENTRY,
	SJE.RECID,
	SJE.ACCOUNTINGEVENT,
	AE.RECID,
	AE.SOURCEDOCUMENTHEADER,
	SDH.RECID
*/
FROM GENERALJOURNALENTRY GJE
JOIN GENERALJOURNALACCOUNTENTRY GJAE ON GJE.RECID = GJAE.GeneralJournalEntry
JOIN POSTINGTYPE PT ON PT.Value = GJAE.POSTINGTYPE
JOIN JOURNALCATEGORY JC ON GJE.JOURNALCATEGORY = JC.Value
/*JOIN SUBLEDGERJOURNALACCOUNTENTRY SJAE ON GJAE.RECID = SJAE.GENERALJOURNALACCOUNTENTRY
JOIN SUBLEDGERJOURNALENTRY SJE ON SJAE.SUBLEDGERJOURNALENTRY = SJE.RECID
JOIN ACCOUNTINGEVENT AE ON SJE.ACCOUNTINGEVENT = AE.RECID
JOIN SOURCEDOCUMENTHEADER SDH ON AE.SOURCEDOCUMENTHEADER = SDH.RECID
*/
-- ORDER BY GJE.RECID ASC

-- Capire cosa mettere? Left outer? Right outer? Outer? Booooh




WITH RankedRows AS (
    SELECT DISTINCT
        GJAE.RECID as GjaeRecId,
        DAGCA.VALUE as GroupChartOfAccountsValue,
        GJE.PostingLayer,
        GJE.SubledgerVoucherDataAreaId,
        GJE.CreatedBy,
        GJAE.Text,
        CPA.Id,
        ROW_NUMBER() OVER (PARTITION BY CPA.Id ORDER BY GJAE.RECID) AS RowNum
    FROM 
        GENERALJOURNALENTRY GJE
        JOIN GENERALJOURNALACCOUNTENTRY GJAE ON GJE.RECID = GJAE.GeneralJournalEntry
        JOIN POSTINGTYPE PT ON PT.Value = GJAE.POSTINGTYPE
        JOIN JOURNALCATEGORY JC ON GJE.JOURNALCATEGORY = JC.Value
        JOIN DIMENSIONATTRIBUTEVALUECOMBINATION DAVC ON GJAE.LEDGERDIMENSION = DAVC.RECID
        JOIN DIMATTRIBUTEGROUPCHARTOFACCOUNTS DAGCA ON DAGCA.VALUE = DAVC.GROUPCHARTOFACCOUNTSVALUE
        LEFT JOIN LEDGERJOURNALTRANSACTION LJT ON LJT.GENERALJOURNALENTRY = GJE.RECID
        LEFT JOIN LEDGERJOURNALTYPE LJTY ON LJTY.Value = LJT.JOURNALTYPE
        JOIN MAPPINGCLOSINGPERIODACTIVITY MCPA ON MCPA.postingtypelabel = pt.label AND MCPA.journalcategorylabel = jc.label
        JOIN CLOSINGPERIODACTIVITY CPA ON CPA.Id = MCPA.ActivityId
    WHERE  
        GJAE.Text != ''
)
SELECT 
    GjaeRecId,
    GroupChartOfAccountsValue,
    PostingLayer,
    SubledgerVoucherDataAreaId,
    CreatedBy,
    Text,
    Id
FROM RankedRows
WHERE RowNum <= 600000;


